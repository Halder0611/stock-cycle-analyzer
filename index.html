<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock & Mutual Fund Cycle Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen">

<div class="max-w-7xl mx-auto p-6 space-y-6">

  <!-- HEADER -->
  <header>
    <h1 class="text-2xl font-semibold">Stock & Mutual Fund Cycle Analyzer</h1>
    <p class="text-slate-400 text-sm">
      Analyze rolling cycles, returns, and long-term growth
    </p>
  </header>

  <!-- INPUTS -->
  <section class="bg-slate-900 border border-slate-800 rounded-xl p-6">
    <h2 class="text-lg font-medium mb-4">Analysis Inputs</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">

      <!-- SYMBOL -->
      <div>
        <label class="block text-sm text-slate-400 mb-1">Stock / Fund</label>
        <input id="symbol"
          placeholder="TCS, AAPL, VFIAX"
          oninput="suggest()"
          class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2 focus:outline-none focus:ring focus:ring-blue-600" />
        <div id="suggestions"
          class="absolute bg-slate-900 border border-slate-700 rounded-md mt-1 z-10"></div>
      </div>

      <!-- END DATE -->
      <div>
        <label class="block text-sm text-slate-400 mb-1">Analysis End Date</label>
        <input id="end_date" type="date"
          class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2" />
      </div>

      <!-- DURATION VALUE -->
      <div>
        <label class="block text-sm text-slate-400 mb-1">Cycle Duration</label>
        <input id="duration_value" type="number" value="1" min="1"
          class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2" />
      </div>

      <!-- DURATION UNIT -->
      <div>
        <label class="block text-sm text-slate-400 mb-1">Duration Unit</label>
        <select id="duration_unit"
          class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2">
          <option value="years">Years</option>
          <option value="months">Months</option>
          <option value="days">Days</option>
        </select>
      </div>

      <!-- CYCLES -->
      <div>
        <label class="block text-sm text-slate-400 mb-1">Number of Cycles</label>
        <input id="cycles" type="number" value="5" min="1"
          class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2" />
      </div>

      <!-- ASSET TYPE -->
      <div>
        <label class="block text-sm text-slate-400 mb-1">Asset Type</label>
        <select id="asset_type"
          class="w-full bg-slate-950 border border-slate-700 rounded-md px-3 py-2">
          <option value="stock">Stock</option>
          <option value="mf">Mutual Fund</option>
        </select>
      </div>

      <!-- BUTTON -->
      <div class="flex items-end">
        <button onclick="run()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-md">
          Analyze
        </button>
      </div>
    </div>
  </section>

  <!-- SUMMARY + TABLE -->
  <section class="bg-slate-900 border border-slate-800 rounded-xl p-6">
    <h2 class="text-lg font-medium mb-4">Cycle Results</h2>

    <div class="flex flex-wrap gap-6 text-sm mb-4">
      <div id="avg" class="text-slate-300"></div>
      <div id="cagr" class="text-slate-300"></div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm border border-slate-800 rounded-lg overflow-hidden">
        <thead class="bg-slate-800 text-slate-400">
          <tr>
            <th class="px-3 py-2">Cycle</th>
            <th class="px-3 py-2">From</th>
            <th class="px-3 py-2">To</th>
            <th class="px-3 py-2">Return %</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-slate-800"></tbody>
      </table>
    </div>
  </section>

  <!-- GRAPH -->
  <section class="bg-slate-900 border border-slate-800 rounded-xl p-6">
    <h2 class="text-lg font-medium mb-4">Price Trend (Cycle Boundaries)</h2>
    <canvas id="priceChart" height="280"></canvas>
  </section>

</div>

<script>
/* ---------- SEARCH ---------- */
const STOCKS = [
  { name: "Tata Consultancy Services", symbol: "TCS.NS" },
  { name: "Reliance Industries", symbol: "RELIANCE.NS" },
  { name: "Infosys", symbol: "INFY.NS" },
  { name: "HDFC Bank", symbol: "HDFCBANK.NS" },
  { name: "Apple", symbol: "AAPL" },
  { name: "Microsoft", symbol: "MSFT" }
];

function suggest() {
  const q = symbol.value.toLowerCase();
  const box = document.getElementById("suggestions");
  box.innerHTML = "";
  if (!q) return;

  STOCKS.filter(s => s.name.toLowerCase().includes(q))
    .slice(0, 5)
    .forEach(s => {
      const d = document.createElement("div");
      d.className = "px-3 py-2 hover:bg-slate-800 cursor-pointer text-sm";
      d.textContent = `${s.name} (${s.symbol})`;
      d.onclick = () => { symbol.value = s.symbol; box.innerHTML = ""; };
      box.appendChild(d);
    });
}

/* ---------- GRAPH + TABLE ---------- */
let chart = null;

async function run() {
  const params = new URLSearchParams({
    symbol: symbol.value.trim(),
    end_date: end_date.value,
    cycles: cycles.value,
    duration_value: duration_value.value,
    duration_unit: duration_unit.value,
    asset_type: asset_type.value
  });

  const analyzeData = await (await fetch("/analyze?" + params)).json();
  const priceData = await (await fetch("/price-series?" + params)).json();
  if (!priceData.dates) return;

  renderTable(analyzeData);
  drawChart(priceData);
}

function renderTable(data) {
  tableBody.innerHTML = "";

  avg.textContent = `Average Cycle Return: ${data.average_growth_percent}%`;
  cagr.textContent = data.cagr_percent !== undefined
    ? `CAGR: ${data.cagr_percent}%` : "";

  data.results.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-3 py-2 text-center">${r.cycle}</td>
      <td class="px-3 py-2 text-center">${r.from}</td>
      <td class="px-3 py-2 text-center">${r.to}</td>
      <td class="px-3 py-2 text-center ${r.growth_percent >= 0 ? "text-green-400" : "text-red-400"}">
        ${r.growth_percent}
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

function drawChart(data) {
  const ctx = priceChart.getContext("2d");
  if (chart) chart.destroy();

  const index = {};
  data.dates.forEach((d, i) => index[d] = i);

  const points = data.cycles
    .map(c => index[c.end] !== undefined
      ? { x: index[c.end], y: data.prices[index[c.end]] }
      : null)
    .filter(Boolean);

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.dates,
      datasets: [
        {
          label: "Price",
          data: data.prices,
          borderColor: "#60a5fa",
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25
        },
        {
          label: "Cycle Boundary",
          data: points,
          showLine: false,
          pointRadius: 6,
          backgroundColor: "#22c55e"
        }
      ]
    },
    options: {
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        y: { ticks: { callback: v => "â‚¹" + v } }
      }
    }
  });
}
</script>

</body>
</html>
