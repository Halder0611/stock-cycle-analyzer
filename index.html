<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cycle Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen">

<div class="max-w-7xl mx-auto p-6 space-y-8">

  <!-- HEADER -->
  <header>
    <h1 class="text-2xl font-semibold">Stock & MF Cycle Analyzer</h1>
    <p class="text-slate-400 text-sm">
      Rolling returns â€¢ Risk â€¢ Hurdle-based Sharpe
    </p>
  </header>

  <!-- INPUTS -->
  <section class="bg-slate-900 border border-slate-800 rounded-xl p-6">
    <h2 class="text-lg font-medium mb-4">Analysis Inputs</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">

      <div>
        <label class="text-sm text-slate-400">Symbol</label>
        <input id="symbol" placeholder="TCS.NS, ^NSEI, AAPL"
          class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2" />
      </div>

      <div>
        <label class="text-sm text-slate-400">End Date</label>
        <input id="end_date" type="date"
          class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2" />
      </div>

      <div>
        <label class="text-sm text-slate-400">Cycle Duration</label>
        <input id="duration_value" type="number" value="1" min="1"
          class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2" />
      </div>

      <div>
        <label class="text-sm text-slate-400">Duration Unit</label>
        <select id="duration_unit"
          class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2">
          <option value="years">Years</option>
          <option value="months">Months</option>
          <option value="days">Days</option>
        </select>
      </div>

      <div>
        <label class="text-sm text-slate-400">Number of Cycles</label>
        <input id="cycles" type="number" value="5" min="1"
          class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2" />
      </div>

      <div>
        <label class="text-sm text-slate-400">Asset Type</label>
        <select id="asset_type"
          class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2">
          <option value="stock">Stock</option>
          <option value="mf">Mutual Fund</option>
        </select>
      </div>

      <div>
        <label class="text-sm text-slate-400">Risk-free / Hurdle Rate (%)</label>
        <input id="risk_free_rate" type="number" step="0.1" value="6.0"
          class="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2" />
      </div>

      <div class="flex items-end">
        <button onclick="run()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded">
          Analyze
        </button>
      </div>

    </div>
  </section>

  <!-- SUMMARY -->
  <section class="bg-slate-900 border border-slate-800 rounded-xl p-6">
    <h2 class="text-lg font-medium mb-3">Summary</h2>
    <div class="flex flex-wrap gap-8 text-sm">
      <div id="avg"></div>
      <div id="std"></div>
      <div id="sharpe"></div>
      <div id="cagr"></div>
    </div>
  </section>

  <!-- TABLE -->
  <section class="bg-slate-900 border border-slate-800 rounded-xl p-6">
    <h2 class="text-lg font-medium mb-3">Cycle Returns</h2>

    <table class="w-full text-sm border border-slate-800 rounded overflow-hidden">
      <thead class="bg-slate-800 text-slate-400">
        <tr>
          <th class="px-3 py-2">Cycle</th>
          <th class="px-3 py-2">From</th>
          <th class="px-3 py-2">To</th>
          <th class="px-3 py-2">Return %</th>
        </tr>
      </thead>
      <tbody id="tableBody" class="divide-y divide-slate-800"></tbody>
    </table>
  </section>

  <!-- GRAPH -->
  <section class="bg-slate-900 border border-slate-800 rounded-xl p-6">
    <h2 class="text-lg font-medium mb-3">Price Trend (Cycle Boundaries)</h2>
    <canvas id="priceChart" height="300"></canvas>
  </section>

</div>

<script>
let chart = null;

async function run() {
  const params = new URLSearchParams({
    symbol: symbol.value.trim(),
    end_date: end_date.value,
    cycles: cycles.value,
    duration_value: duration_value.value,
    duration_unit: duration_unit.value,
    asset_type: asset_type.value,
    risk_free_rate: risk_free_rate.value
  });

  const analyze = await (await fetch("/analyze?" + params)).json();
  const price = await (await fetch("/price-series?" + params)).json();
  if (!price.dates) return;

  avg.textContent = `Average Return: ${analyze.average_growth_percent}%`;
  std.textContent = `Std Dev: ${analyze.std_dev_percent}%`;
  sharpe.textContent =
    `Sharpe (hurdle ${analyze.risk_free_rate_used}%): ${analyze.sharpe_ratio}`;
  cagr.textContent = analyze.cagr_percent
    ? `CAGR: ${analyze.cagr_percent}%`
    : "";

  tableBody.innerHTML = "";
  analyze.results.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-3 py-2 text-center">${r.cycle}</td>
      <td class="px-3 py-2 text-center">${r.from}</td>
      <td class="px-3 py-2 text-center">${r.to}</td>
      <td class="px-3 py-2 text-center ${r.growth_percent >= 0 ? "text-green-400" : "text-red-400"}">
        ${r.growth_percent}
      </td>`;
    tableBody.appendChild(tr);
  });

  drawChart(price);
}

function drawChart(data) {
  const ctx = priceChart.getContext("2d");
  if (chart) chart.destroy();

  // map date -> index
  const index = {};
  data.dates.forEach((d, i) => index[d] = i);

  // points EXACTLY on price line (cycle end)
  const points = data.cycles
    .map(c => {
      const i = index[c.end];
      return i !== undefined
        ? { x: i, y: data.prices[i] }
        : null;
    })
    .filter(Boolean);

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.dates,
      datasets: [
        {
          label: "Price",
          data: data.prices,
          borderColor: "#60a5fa",
          borderWidth: 2.2,
          pointRadius: 0,
          tension: 0.25
        },
        {
          label: "Cycle Boundary",
          data: points,
          showLine: false,
          pointRadius: 4,              // ðŸ‘ˆ smaller dots
          pointHoverRadius: 6,
          backgroundColor: "#22c55e",  // ðŸ‘ˆ clean green
          borderColor: "#16a34a"
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { boxWidth: 12 } }
      },
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        y: {
          ticks: { callback: v => "â‚¹" + v }
        }
      }
    }
  });
}
</script>

</body>
</html>
