<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock & Mutual Fund Cycle Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .gradient-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    .card { background: #1a1f2e; border: 1px solid #2d3748; transition: all 0.3s ease; }
    .card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); }
    .input-field { transition: all 0.2s ease; }
    .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .stat-card { background: #111827; border: 1px solid #2d3748; border-left: 3px solid #3b82f6; }
    .stat-positive { border-left-color: #10b981; }
    .stat-negative { border-left-color: #ef4444; }
    .section-title { font-size: 1.25rem; font-weight: 500; color: #e2e8f0; letter-spacing: -0.5px; }
  </style>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen">

<div class="max-w-6xl mx-auto p-6 space-y-6">

  <!-- HEADER -->
  <header class="mb-8">
    <h1 class="text-3xl font-medium text-slate-100">Stock & Mutual Fund Cycle Analyzer</h1>
    <p class="text-slate-400 text-sm mt-2">Rolling returns • Risk analysis • Hurdle-based Sharpe ratio</p>
  </header>

  <!-- INPUTS -->
  <section class="card rounded-lg p-6">
    <h2 class="section-title mb-5">Analysis Inputs</h2>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">

      <div>
        <label class="text-xs font-medium text-slate-400 block mb-2">Symbol</label>
        <div class="relative">
          <input id="symbol" placeholder="TCS.NS, ^NSEI, AAPL" value="^NSEI"
            class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 placeholder-slate-500 input-field" 
            autocomplete="off"
            oninput="searchSymbols(this.value)" />
          <div id="symbolSuggestions" class="absolute top-full left-0 right-0 bg-slate-800 border border-slate-700 rounded mt-1 max-h-48 overflow-y-auto shadow-lg hidden z-10">
          </div>
        </div>
      </div>

      <div>
        <label class="text-xs font-medium text-slate-400 block mb-2">End Date</label>
        <input id="end_date" type="date"
          class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 input-field" />
      </div>

      <div>
        <label class="text-xs font-medium text-slate-400 block mb-2">Duration</label>
        <div class="flex gap-2">
          <input id="duration_value" type="number" value="1" min="1" max="100"
            class="w-2/3 bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 input-field" />
          <select id="duration_unit"
            class="w-1/3 bg-slate-900 border border-slate-700 rounded px-2 py-2 text-sm text-slate-100 input-field">
            <option value="years">Years</option>
            <option value="months">Months</option>
            <option value="days">Days</option>
          </select>
        </div>
      </div>

      <div>
        <label class="text-xs font-medium text-slate-400 block mb-2">Cycles</label>
        <input id="cycles" type="number" value="5" min="1" max="50"
          class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 input-field" />
      </div>

      <div>
        <label class="text-xs font-medium text-slate-400 block mb-2">Asset Type</label>
        <select id="asset_type"
          class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 input-field">
          <option value="stock">Stock</option>
          <option value="mf">Mutual Fund</option>
        </select>
      </div>

      <div>
        <label class="text-xs font-medium text-slate-400 block mb-2">Risk-free Rate (%)</label>
        <input id="risk_free_rate" type="number" step="0.1" value="6.0" min="0" max="100"
          class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-slate-100 input-field" />
      </div>

      <div class="lg:col-span-2 flex gap-3">
        <button onclick="run()" 
          class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm px-4 py-2 rounded transition">
          Analyze
        </button>
        <button onclick="clearForm()" 
          class="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-100 font-medium text-sm px-4 py-2 rounded transition">
          Clear
        </button>
      </div>

    </div>
  </section>

  <!-- SUMMARY -->
  <section class="card rounded-lg p-6">
    <h2 class="section-title mb-4">Summary Statistics</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
      <div id="avg" class="stat-card p-4 rounded text-sm"></div>
      <div id="std" class="stat-card p-4 rounded text-sm"></div>
      <div id="sharpe" class="stat-card p-4 rounded text-sm"></div>
      <div id="cagr" class="stat-card p-4 rounded text-sm"></div>
    </div>
    <div id="error" class="mt-4 p-4 bg-red-950/50 border border-red-700/50 rounded text-red-300 text-sm hidden"></div>
  </section>

  <!-- TABLE -->
  <section class="card rounded-lg p-6">
    <h2 class="section-title mb-4">Cycle-by-Cycle Returns</h2>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-slate-800 border-b border-slate-700">
          <tr>
            <th class="px-4 py-3 text-left font-medium text-slate-400">Cycle</th>
            <th class="px-4 py-3 text-center font-medium text-slate-400">From</th>
            <th class="px-4 py-3 text-center font-medium text-slate-400">To</th>
            <th class="px-4 py-3 text-right font-medium text-slate-400">Return %</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-slate-800">
          <tr class="text-slate-500">
            <td colspan="4" class="px-4 py-8 text-center text-sm">Run analysis to see cycle returns</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- GRAPH -->
  <section class="card rounded-lg p-6">
    <h2 class="section-title mb-4">Price Trend & Cycle Boundaries</h2>
    <div class="bg-slate-900 rounded p-4 w-full" style="min-height: 450px;">
      <canvas id="priceChart"></canvas>
    </div>
  </section>

  <!-- BAR CHART -->
  <section class="card rounded-lg p-6">
    <h2 class="section-title mb-4">Cycle Returns Distribution</h2>
    <div class="bg-slate-900 rounded p-4 w-full" style="min-height: 350px;">
      <canvas id="barChart"></canvas>
    </div>
  </section>

</div>

<script>
let chart = null;
let barChart = null;
let searchTimeout = null;

function searchSymbols(query) {
  const suggestionsDiv = document.getElementById('symbolSuggestions');
  
  if (!query || query.length < 1) {
    suggestionsDiv.classList.add('hidden');
    return;
  }

  clearTimeout(searchTimeout);
  
  searchTimeout = setTimeout(async () => {
    try {
      const response = await fetch(`/search-symbols?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      if (data.results && data.results.length > 0) {
        suggestionsDiv.innerHTML = data.results
          .map(r => `
            <div class="px-3 py-2 hover:bg-slate-700 cursor-pointer text-sm text-slate-100 border-b border-slate-700" 
                 onclick="selectSymbol('${r.symbol}')">
              <span class="font-medium">${r.symbol}</span>
              <span class="text-slate-400 ml-2">${r.name}</span>
            </div>
          `)
          .join('');
        suggestionsDiv.classList.remove('hidden');
      } else {
        suggestionsDiv.classList.add('hidden');
      }
    } catch (e) {
      console.error('Search error:', e);
    }
  }, 300);
}

function selectSymbol(symbol) {
  document.getElementById('symbol').value = symbol;
  document.getElementById('symbolSuggestions').classList.add('hidden');
}

// Close suggestions when clicking outside
document.addEventListener('click', (e) => {
  if (e.target.id !== 'symbol') {
    document.getElementById('symbolSuggestions').classList.add('hidden');
  }
});

function formatValue(label, value, isPercent = false) {
  if (value === null || value === undefined || isNaN(value)) return `${label}: N/A`;
  const formatted = isPercent ? `${parseFloat(value).toFixed(2)}%` : parseFloat(value).toFixed(2);
  return `<span class="font-semibold text-slate-100">${formatted}</span>`;
}

async function run() {
  try {
    const errorDiv = document.getElementById('error');
    errorDiv.classList.add('hidden');

    const symbol = document.getElementById('symbol')?.value?.trim();
    const end_date = document.getElementById('end_date')?.value;
    const cycles = document.getElementById('cycles')?.value;
    const duration_value = document.getElementById('duration_value')?.value;
    const duration_unit = document.getElementById('duration_unit')?.value;
    const asset_type = document.getElementById('asset_type')?.value;
    const risk_free_rate = document.getElementById('risk_free_rate')?.value;

    if (!symbol || !end_date) {
      showError('Please fill in Symbol and End Date');
      return;
    }

    const params = new URLSearchParams({
      symbol, end_date, cycles, duration_value, duration_unit, asset_type, risk_free_rate
    });

    const analyzeResp = await fetch("/analyze?" + params);
    if (!analyzeResp.ok) {
      const err = await analyzeResp.json().catch(() => ({}));
      showError(err.detail || 'Analysis failed. Check symbol and date.');
      return;
    }
    const analyze = await analyzeResp.json();

    const priceResp = await fetch("/price-series?" + params);
    if (!priceResp.ok) {
      showError('Price data unavailable');
      return;
    }
    const price = await priceResp.json();

    if (!price?.dates || !Array.isArray(price.dates) || price.dates.length === 0) {
      showError('No price data available for this symbol');
      return;
    }

    // Update summary
    document.getElementById('avg').innerHTML = `<div class="text-xs text-slate-400 mb-1">Average Return</div>${formatValue('', analyze.average_growth_percent, true)}`;
    document.getElementById('std').innerHTML = `<div class="text-xs text-slate-400 mb-1">Std Deviation</div>${formatValue('', analyze.std_dev_percent, true)}`;
    document.getElementById('sharpe').innerHTML = `<div class="text-xs text-slate-400 mb-1">Sharpe Ratio</div><span class="font-semibold text-slate-100">${parseFloat(analyze.sharpe_ratio || 0).toFixed(2)}</span>`;
    document.getElementById('cagr').innerHTML = analyze.cagr_percent ? `<div class="text-xs text-slate-400 mb-1">CAGR</div>${formatValue('', analyze.cagr_percent, true)}` : '';

    // Update table
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    if (analyze.results && Array.isArray(analyze.results)) {
      analyze.results.forEach(r => {
        const tr = document.createElement('tr');
        const isPositive = parseFloat(r.growth_percent) >= 0;
        tr.className = 'hover:bg-slate-700/30 transition';
        tr.innerHTML = `
          <td class="px-4 py-3 font-medium text-slate-100">Cycle ${r.cycle}</td>
          <td class="px-4 py-3 text-center text-slate-400">${r.from}</td>
          <td class="px-4 py-3 text-center text-slate-400">${r.to}</td>
          <td class="px-4 py-3 text-right font-semibold ${isPositive ? 'text-green-400' : 'text-red-400'}">
            ${isPositive ? '+' : ''}${parseFloat(r.growth_percent).toFixed(2)}%
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    drawChart(price);
    drawBarChart(analyze.results);
  } catch (e) {
    showError('An error occurred: ' + e.message);
  }
}

function showError(msg) {
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = 'Error: ' + msg;
  errorDiv.classList.remove('hidden');
}

function clearForm() {
  document.getElementById('symbol').value = '^NSEI';
  document.getElementById('end_date').value = '';
  document.getElementById('duration_value').value = '1';
  document.getElementById('duration_unit').value = 'years';
  document.getElementById('cycles').value = '5';
  document.getElementById('asset_type').value = 'stock';
  document.getElementById('risk_free_rate').value = '6.0';
  document.getElementById('tableBody').innerHTML = '<tr class="text-slate-500"><td colspan="4" class="px-4 py-8 text-center">Run analysis to see cycle returns</td></tr>';
  if (chart) chart.destroy();
  if (barChart) barChart.destroy();
}

function drawBarChart(results) {
  const ctx = document.getElementById('barChart')?.getContext('2d');
  if (!ctx) return;
  if (barChart) barChart.destroy();

  const cycleLabels = results.map(r => `Cycle ${r.cycle}`);
  const cycleReturns = results.map(r => parseFloat(r.growth_percent));

  // Color bars based on positive/negative
  const barColors = cycleReturns.map(val => val >= 0 ? '#10b981' : '#ef4444');

  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: cycleLabels,
      datasets: [
        {
          label: 'Return %',
          data: cycleReturns,
          backgroundColor: barColors,
          borderColor: barColors,
          borderWidth: 1.5,
          borderRadius: 6,
          barThickness: 'flex',
          maxBarThickness: 60
        }
      ]
    },
    options: {
      indexAxis: undefined,
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { boxWidth: 12, font: { size: 12 }, color: '#94a3b8' }
        }
      },
      scales: {
        x: {
          ticks: { color: '#64748b', font: { size: 11 } },
          grid: { color: 'rgba(100, 116, 139, 0.1)' }
        },
        y: {
          ticks: {
            color: '#64748b',
            font: { size: 11 },
            callback: v => v.toFixed(1) + '%'
          },
          grid: { color: 'rgba(100, 116, 139, 0.1)' },
          title: { display: true, text: 'Return %' }
        }
      }
    }
  });
}

function drawChart(data) {
  const ctx = document.getElementById('priceChart')?.getContext('2d');
  if (!ctx) return;
  if (chart) chart.destroy();

  // Create mapping of dates to prices for boundary points
  const dateIndexMap = {};
  (data.dates || []).forEach((d, i) => {
    dateIndexMap[d] = (data.prices || [])[i];
  });

  // Create boundary points using date labels directly
  const boundaryPoints = (data.cycles || [])
    .map(c => {
      const price = dateIndexMap[c.end];
      return price !== undefined ? { x: c.end, y: price } : null;
    })
    .filter(Boolean);

  // Create connected line data for boundaries
  const boundaryLineData = boundaryPoints.map(p => p.y);
  const boundaryLineLabels = boundaryPoints.map(p => p.x);

  // Plugin to draw vertical line on hover
  const verticalLinePlugin = {
    id: 'verticalLine',
    afterDatasetsDraw(chart) {
      const { ctx, scales, tooltip } = chart;
      if (tooltip._active && tooltip._active.length > 0) {
        const x = tooltip._active[0].element.x;
        const topY = scales.y.top;
        const bottomY = scales.y.bottom;

        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 1.5;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(x, topY);
        ctx.lineTo(x, bottomY);
        ctx.stroke();
        ctx.setLineDash([]);
      }
    }
  };

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.dates || [],
      datasets: [
        {
          label: 'Price',
          data: data.prices || [],
          borderColor: '#3b82f6',
          borderWidth: 2.5,
          pointRadius: 0,
          fill: false,
          tension: 0.3
        },
        {
          label: 'Cycle Boundaries',
          data: boundaryPoints,
          borderColor: '#10b981',
          backgroundColor: '#10b981',
          borderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor: '#10b981',
          pointBorderColor: '#059669',
          pointBorderWidth: 2,
          showLine: true,
          tension: 0.2,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        verticalLine: {},
        legend: {
          labels: { boxWidth: 12, font: { size: 12 }, color: '#94a3b8' }
        },
        tooltip: {
          enabled: true,
          mode: 'index',
          intersect: false,
          backgroundColor: '#1a1f2e',
          borderColor: '#3b82f6',
          borderWidth: 1,
          titleColor: '#e2e8f0',
          bodyColor: '#cbd5e1',
          padding: 8,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0]?.label || '';
            },
            label: function(context) {
              if (context.datasetIndex === 0) {
                return '₹ ' + parseFloat(context.parsed.y).toLocaleString('en-IN', {maximumFractionDigits: 2});
              }
              return context.dataset.label;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { maxTicksLimit: 8, color: '#64748b', font: { size: 11 } },
          grid: { color: 'rgba(100, 116, 139, 0.1)' }
        },
        y: {
          ticks: {
            color: '#64748b',
            font: { size: 11 },
            callback: v => '₹' + (v || 0).toLocaleString('en-IN')
          },
          grid: { color: 'rgba(100, 116, 139, 0.1)' }
        }
      }
    },
    plugins: [verticalLinePlugin]
  });
}

// Set today's date as default end date
window.addEventListener('load', () => {
  const today = new Date().toISOString().split('T')[0];
  const endDateInput = document.getElementById('end_date');
  if (endDateInput && !endDateInput.value) {
    endDateInput.value = today;
  }
});
</script>

</body>
</html> 
