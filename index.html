<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock & Mutual Fund Cycle Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .gradient-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .input-field { transition: all 0.2s ease; }
    .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .stat-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-left: 3px solid #3b82f6; }
    .stat-positive { border-left-color: #10b981; }
    .stat-negative { border-left-color: #ef4444; }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-200 min-h-screen">

<div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-8">

  <!-- HEADER -->
  <header class="gradient-header rounded-2xl p-8 sm:p-12 shadow-2xl">
    <h1 class="text-4xl sm:text-5xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
      Stock & Mutual Fund Cycle Analyzer
    </h1>
    <p class="text-slate-400 text-base sm:text-lg mt-3">
      Rolling returns • Risk analysis • Hurdle-based Sharpe ratio
    </p>
  </header>

  <!-- INPUTS -->
  <section class="bg-slate-900/50 backdrop-blur border border-slate-700/50 rounded-2xl p-6 sm:p-8 card-hover shadow-xl">
    <h2 class="text-2xl font-semibold mb-6 text-slate-100">Analysis Inputs</h2>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">

      <div class="lg:col-span-1">
        <label class="text-sm font-medium text-slate-300 block mb-2">Symbol</label>
        <input id="symbol" placeholder="e.g., TCS.NS, ^NSEI" value="^NSEI"
          class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-2.5 text-slate-100 placeholder-slate-500 input-field" />
        <p class="text-xs text-slate-500 mt-1">Yahoo Finance symbol</p>
      </div>

      <div class="lg:col-span-1">
        <label class="text-sm font-medium text-slate-300 block mb-2">End Date</label>
        <input id="end_date" type="date"
          class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-2.5 text-slate-100 input-field" />
      </div>

      <div class="lg:col-span-1">
        <label class="text-sm font-medium text-slate-300 block mb-2">Cycle Duration</label>
        <div class="flex gap-2">
          <input id="duration_value" type="number" value="1" min="1" max="100"
            class="w-2/3 bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-2.5 text-slate-100 input-field" />
          <select id="duration_unit"
            class="w-1/3 bg-slate-800/50 border border-slate-600 rounded-lg px-2 py-2.5 text-slate-100 input-field text-sm">
            <option value="years">Years</option>
            <option value="months">Months</option>
            <option value="days">Days</option>
          </select>
        </div>
      </div>

      <div class="lg:col-span-1">
        <label class="text-sm font-medium text-slate-300 block mb-2">Number of Cycles</label>
        <input id="cycles" type="number" value="5" min="1" max="50"
          class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-2.5 text-slate-100 input-field" />
      </div>

      <div class="lg:col-span-1">
        <label class="text-sm font-medium text-slate-300 block mb-2">Asset Type</label>
        <select id="asset_type"
          class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-2.5 text-slate-100 input-field">
          <option value="stock">Stock</option>
          <option value="mf">Mutual Fund</option>
        </select>
      </div>

      <div class="lg:col-span-1">
        <label class="text-sm font-medium text-slate-300 block mb-2">Risk-free Rate (%)</label>
        <input id="risk_free_rate" type="number" step="0.1" value="6.0" min="0" max="100"
          class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-2.5 text-slate-100 input-field" />
      </div>

      <div class="lg:col-span-2 flex gap-3">
        <button onclick="run()" 
          class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold px-6 py-2.5 rounded-lg transition duration-200 shadow-lg hover:shadow-blue-500/50 active:scale-95">
          Analyze
        </button>
        <button onclick="clearForm()" 
          class="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold px-6 py-2.5 rounded-lg transition duration-200">
          Clear
        </button>
      </div>

    </div>
  </section>

  <!-- SUMMARY -->
  <section class="bg-slate-900/50 backdrop-blur border border-slate-700/50 rounded-2xl p-6 sm:p-8 card-hover shadow-xl">
    <h2 class="text-2xl font-semibold mb-6 text-slate-100">Summary Statistics</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div id="avg" class="stat-card p-4 rounded-lg"></div>
      <div id="std" class="stat-card p-4 rounded-lg"></div>
      <div id="sharpe" class="stat-card p-4 rounded-lg"></div>
      <div id="cagr" class="stat-card p-4 rounded-lg"></div>
    </div>
    <div id="error" class="mt-4 p-4 bg-red-950/50 border border-red-700/50 rounded-lg text-red-300 hidden"></div>
  </section>

  <!-- TABLE -->
  <section class="bg-slate-900/50 backdrop-blur border border-slate-700/50 rounded-2xl p-6 sm:p-8 card-hover shadow-xl">
    <h2 class="text-2xl font-semibold mb-6 text-slate-100">Cycle-by-Cycle Returns</h2>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-slate-800/70 border-b border-slate-700">
          <tr>
            <th class="px-4 py-3 text-left font-semibold text-slate-300">Cycle</th>
            <th class="px-4 py-3 text-center font-semibold text-slate-300">From</th>
            <th class="px-4 py-3 text-center font-semibold text-slate-300">To</th>
            <th class="px-4 py-3 text-right font-semibold text-slate-300">Return %</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-slate-700/50">
          <tr class="text-slate-500">
            <td colspan="4" class="px-4 py-8 text-center">Run analysis to see cycle returns</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- GRAPH -->
  <section class="bg-slate-900/50 backdrop-blur border border-slate-700/50 rounded-2xl p-6 sm:p-8 card-hover shadow-xl">
    <h2 class="text-2xl font-semibold mb-6 text-slate-100">Price Trend & Cycle Boundaries</h2>
    <div class="bg-slate-800/30 rounded-lg p-4 w-full" style="min-height: 500px;">
      <canvas id="priceChart"></canvas>
    </div>
  </section>

  <!-- BAR CHART -->
  <section class="bg-slate-900/50 backdrop-blur border border-slate-700/50 rounded-2xl p-6 sm:p-8 card-hover shadow-xl">
    <h2 class="text-2xl font-semibold mb-6 text-slate-100">Cycle Returns Distribution</h2>
    <div class="bg-slate-800/30 rounded-lg p-4 w-full" style="min-height: 400px;">
      <canvas id="barChart"></canvas>
    </div>
  </section>

</div>

<script>
let chart = null;
let barChart = null;

function formatValue(label, value, isPercent = false) {
  if (value === null || value === undefined || isNaN(value)) return `${label}: N/A`;
  const formatted = isPercent ? `${parseFloat(value).toFixed(2)}%` : parseFloat(value).toFixed(2);
  return `<span class="font-semibold text-slate-100">${formatted}</span>`;
}

async function run() {
  try {
    const errorDiv = document.getElementById('error');
    errorDiv.classList.add('hidden');

    const symbol = document.getElementById('symbol')?.value?.trim();
    const end_date = document.getElementById('end_date')?.value;
    const cycles = document.getElementById('cycles')?.value;
    const duration_value = document.getElementById('duration_value')?.value;
    const duration_unit = document.getElementById('duration_unit')?.value;
    const asset_type = document.getElementById('asset_type')?.value;
    const risk_free_rate = document.getElementById('risk_free_rate')?.value;

    if (!symbol || !end_date) {
      showError('Please fill in Symbol and End Date');
      return;
    }

    const params = new URLSearchParams({
      symbol, end_date, cycles, duration_value, duration_unit, asset_type, risk_free_rate
    });

    const analyzeResp = await fetch("/analyze?" + params);
    if (!analyzeResp.ok) {
      const err = await analyzeResp.json().catch(() => ({}));
      showError(err.detail || 'Analysis failed. Check symbol and date.');
      return;
    }
    const analyze = await analyzeResp.json();

    const priceResp = await fetch("/price-series?" + params);
    if (!priceResp.ok) {
      showError('Price data unavailable');
      return;
    }
    const price = await priceResp.json();

    if (!price?.dates || !Array.isArray(price.dates) || price.dates.length === 0) {
      showError('No price data available for this symbol');
      return;
    }

    // Update summary
    document.getElementById('avg').innerHTML = `<div class="text-xs text-slate-400 mb-1">Average Return</div>${formatValue('', analyze.average_growth_percent, true)}`;
    document.getElementById('std').innerHTML = `<div class="text-xs text-slate-400 mb-1">Std Deviation</div>${formatValue('', analyze.std_dev_percent, true)}`;
    document.getElementById('sharpe').innerHTML = `<div class="text-xs text-slate-400 mb-1">Sharpe Ratio</div><span class="font-semibold text-slate-100">${parseFloat(analyze.sharpe_ratio || 0).toFixed(2)}</span>`;
    document.getElementById('cagr').innerHTML = analyze.cagr_percent ? `<div class="text-xs text-slate-400 mb-1">CAGR</div>${formatValue('', analyze.cagr_percent, true)}` : '';

    // Update table
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    if (analyze.results && Array.isArray(analyze.results)) {
      analyze.results.forEach(r => {
        const tr = document.createElement('tr');
        const isPositive = parseFloat(r.growth_percent) >= 0;
        tr.className = 'hover:bg-slate-700/30 transition';
        tr.innerHTML = `
          <td class="px-4 py-3 font-medium text-slate-100">Cycle ${r.cycle}</td>
          <td class="px-4 py-3 text-center text-slate-400">${r.from}</td>
          <td class="px-4 py-3 text-center text-slate-400">${r.to}</td>
          <td class="px-4 py-3 text-right font-semibold ${isPositive ? 'text-green-400' : 'text-red-400'}">
            ${isPositive ? '+' : ''}${parseFloat(r.growth_percent).toFixed(2)}%
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    drawChart(price);
    drawBarChart(analyze.results);
  } catch (e) {
    showError('An error occurred: ' + e.message);
  }
}

function showError(msg) {
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = 'Error: ' + msg;
  errorDiv.classList.remove('hidden');
}

function clearForm() {
  document.getElementById('symbol').value = '^NSEI';
  document.getElementById('end_date').value = '';
  document.getElementById('duration_value').value = '1';
  document.getElementById('duration_unit').value = 'years';
  document.getElementById('cycles').value = '5';
  document.getElementById('asset_type').value = 'stock';
  document.getElementById('risk_free_rate').value = '6.0';
  document.getElementById('tableBody').innerHTML = '<tr class="text-slate-500"><td colspan="4" class="px-4 py-8 text-center">Run analysis to see cycle returns</td></tr>';
  if (chart) chart.destroy();
  if (barChart) barChart.destroy();
}

function drawBarChart(results) {
  const ctx = document.getElementById('barChart')?.getContext('2d');
  if (!ctx) return;
  if (barChart) barChart.destroy();

  const cycleLabels = results.map(r => `Cycle ${r.cycle}`);
  const cycleReturns = results.map(r => parseFloat(r.growth_percent));

  // Color bars based on positive/negative
  const barColors = cycleReturns.map(val => val >= 0 ? '#10b981' : '#ef4444');

  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: cycleLabels,
      datasets: [
        {
          label: 'Return %',
          data: cycleReturns,
          backgroundColor: barColors,
          borderColor: barColors,
          borderWidth: 1.5,
          borderRadius: 6,
          barThickness: 'flex',
          maxBarThickness: 60
        }
      ]
    },
    options: {
      indexAxis: undefined,
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { boxWidth: 12, font: { size: 12 }, color: '#94a3b8' }
        }
      },
      scales: {
        x: {
          ticks: { color: '#64748b', font: { size: 11 } },
          grid: { color: 'rgba(100, 116, 139, 0.1)' }
        },
        y: {
          ticks: {
            color: '#64748b',
            font: { size: 11 },
            callback: v => v.toFixed(1) + '%'
          },
          grid: { color: 'rgba(100, 116, 139, 0.1)' },
          title: { display: true, text: 'Return %' }
        }
      }
    }
  });
}

function drawChart(data) {
  const ctx = document.getElementById('priceChart')?.getContext('2d');
  if (!ctx) return;
  if (chart) chart.destroy();

  // Create mapping of dates to prices for boundary points
  const dateIndexMap = {};
  (data.dates || []).forEach((d, i) => {
    dateIndexMap[d] = (data.prices || [])[i];
  });

  // Create boundary points using date labels directly
  const boundaryPoints = (data.cycles || [])
    .map(c => {
      const price = dateIndexMap[c.end];
      return price !== undefined ? { x: c.end, y: price } : null;
    })
    .filter(Boolean);

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.dates || [],
      datasets: [
        {
          label: 'Price',
          data: data.prices || [],
          borderColor: '#3b82f6',
          borderWidth: 2.5,
          pointRadius: 0,
          fill: false,
          tension: 0.3
        },
        {
          label: 'Cycle Boundary',
          data: boundaryPoints,
          showLine: false,
          pointRadius: 5,
          pointHoverRadius: 7,
          backgroundColor: '#10b981',
          borderColor: '#059669',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { boxWidth: 12, font: { size: 12 }, color: '#94a3b8' }
        }
      },
      scales: {
        x: {
          ticks: { maxTicksLimit: 8, color: '#64748b', font: { size: 11 } },
          grid: { color: 'rgba(100, 116, 139, 0.1)' }
        },
        y: {
          ticks: {
            color: '#64748b',
            font: { size: 11 },
            callback: v => '₹' + (v || 0).toLocaleString('en-IN')
          },
          grid: { color: 'rgba(100, 116, 139, 0.1)' }
        }
      }
    }
  });
}

// Set today's date as default end date
window.addEventListener('load', () => {
  const today = new Date().toISOString().split('T')[0];
  const endDateInput = document.getElementById('end_date');
  if (endDateInput && !endDateInput.value) {
    endDateInput.value = today;
  }
});
</script>

</body>
</html> 
